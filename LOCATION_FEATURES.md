# ميزات الموقع الجديدة

## نظرة عامة
تم إضافة ميزات جديدة لتخزين وإدارة بيانات الموقع للمستخدمين (المعلمين والطلاب) باستخدام مكتبة `node-geocoder` مع مزود OpenCage.

## الحقول الجديدة المضافة

### حقول الموقع الأساسية
- `formattedAddress`: العنوان المُنسق بالكامل
- `country`: الدولة
- `city`: المدينة
- `state`: المحافظة/الولاية
- `zipcode`: الرمز البريدي
- `streetName`: اسم الشارع
- `suburb`: الحي/الضاحية
- `locationConfidence`: مستوى الثقة في بيانات الموقع

### الحقول الموجودة مسبقاً
- `latitude`: خط العرض
- `longitude`: خط الطول

## كيفية الاستخدام

### 1. تسجيل معلم جديد مع بيانات الموقع
```json
{
  "name": "أحمد محمد",
  "email": "teacher@example.com",
  "password": "Password123",
  "phone": "+964501234567",
  "address": "العراق, بغداد",
  "bio": "مدرس رياضيات مع خبرة 5 سنوات",
  "experienceYears": 5,
  "gradeIds": [
    "99842b1c-d412-41df-99c1-3241bac62fd6",
    "bb851218-dbf2-4daa-8505-1defb7a8d230"
  ],
  "studyYear": "2024-2025",
  "latitude": 33.3687184,
  "longitude": 44.5115104
}
```

### 2. تسجيل طالب جديد مع بيانات الموقع
```json
{
  "name": "فاطمة علي",
  "email": "student@example.com",
  "password": "Password123",
  "studentPhone": "+964501234568",
  "parentPhone": "+964501234569",
  "schoolName": "مدرسة النجاح",
  "gender": "female",
  "birthDate": "2008-05-15",
  "gradeId": "99842b1c-d412-41df-99c1-3241bac62fd6",
  "studyYear": "2024-2025",
  "latitude": 33.3687184,
  "longitude": 44.5115104
}
```

## آلية العمل

### 1. عند التسجيل
- يتم إرسال `latitude` و `longitude` مع بيانات التسجيل
- النظام يستخدم خدمة الجغرافيا لجلب تفاصيل الموقع
- يتم تخزين جميع البيانات في قاعدة البيانات

### 2. خدمة الجغرافيا
- تستخدم مكتبة `node-geocoder` مع مزود OpenCage
- تدعم اللغة العربية
- تركز على العراق كبلد افتراضي
- تعطي نتائج دقيقة مع مستوى ثقة

## متطلبات الإعداد

### 1. متغيرات البيئة
```env
OPENCAGE_API_KEY=your_opencage_api_key_here
```

### 2. تثبيت المكتبات
```bash
npm install node-geocoder
npm install --save-dev @types/node-geocoder
```

### 3. تشغيل الهجرة
```bash
npm run db:init
```

## مزودي الخدمة المدعومون

### OpenCage (المفضل)
- دعم ممتاز للغة العربية
- دقة عالية في العراق
- أسعار معقولة
- [الموقع الرسمي](https://opencagedata.com/)

### OpenStreetMap (OSM)
- مجاني
- دقة متوسطة
- قد يحتاج إلى إعداد إضافي

## استكشاف الأخطاء

### مشاكل شائعة
1. **مفتاح API غير صحيح**: تأكد من صحة مفتاح OpenCage
2. **فشل في جلب بيانات الموقع**: النظام يستمر في التسجيل حتى لو فشلت خدمة الجغرافيا
3. **إحداثيات غير صحيحة**: تأكد من صحة خطوط الطول والعرض

### رسائل الخطأ
- `LOCATION_DETAILS_RETRIEVED`: تم جلب تفاصيل الموقع بنجاح
- `LOCATION_DETAILS_FAILED`: فشل في جلب تفاصيل الموقع
- `INVALID_COORDINATES`: إحداثيات الموقع غير صحيحة

## تحديثات قاعدة البيانات

تم دمج الحقول الجديدة في ملف الهجرة الأساسي `001_create_users_table.sql`:
- إضافة الحقول الجديدة مباشرة في إنشاء الجدول
- إنشاء فهارس لتحسين الأداء
- تحديث الفهارس الموجودة

## ملاحظات مهمة

1. **الأمان**: لا يتم تخزين كلمات المرور كنص عادي
2. **الأداء**: تم إنشاء فهارس للحقول الجديدة
3. **التوافق**: النظام متوافق مع الإصدارات السابقة
4. **المرونة**: يمكن التسجيل بدون بيانات موقع
5. **اللغة**: دعم كامل للغة العربية

## الدعم

للمساعدة أو الاستفسارات، يرجى التواصل مع فريق التطوير.
